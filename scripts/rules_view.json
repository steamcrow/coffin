console.log("üìñ Loading Coffin Canyon Rulebook...");

(async function () {

  const ROOT_ID = "cc-rules-root";
  const JSON_URL = "https://raw.githubusercontent.com/steamcrow/coffin/main/factions/rules.json";

  const root = document.getElementById(ROOT_ID);
  if (!root) {
    console.error("‚ùå cc-rules-root not found");
    return;
  }

  root.innerHTML = `
    <div style="padding:40px; max-width:1100px; margin:0 auto;">
      <h1 style="color:#ff7518; font-weight:900;">COFFIN CANYON RULEBOOK</h1>
      <p>Loading rules...</p>
    </div>
  `;

  const res = await fetch(JSON_URL);
  const data = await res.json();
  const rules = data.rules_master;

  // --- Header ---
  let html = `
    <div class="cc-rulebook" style="padding:40px; max-width:1100px; margin:0 auto;">
      <h1 style="color:#ff7518; font-weight:900;">
        COFFIN CANYON RULEBOOK
      </h1>
      <div style="opacity:0.7; margin-bottom:20px;">
        Version ${rules.version} ¬∑ Last Updated ${rules.last_updated}
      </div>
      <div class="field-notes-box">
        <strong>Changelog:</strong><br>
        ${rules.changelog}
      </div>
  `;

  // --- Table of Contents ---
  html += `<h2>Contents</h2><ul>`;
  for (const key in rules.sections) {
    const title = prettify(key);
    html += `<li><a href="#${key}" class="rule-link">${title}</a></li>`;
  }
  html += `</ul>`;

  // --- Render Each Section ---
  for (const key in rules.sections) {
    const sectionTitle = prettify(key);
    const sectionData = rules[key];

    html += `
      <hr>
      <h2 id="${key}" style="color:#ff7518;">${sectionTitle}</h2>
    `;

    html += renderObject(sectionData);
  }

  html += `</div>`;
  root.innerHTML = html;

  console.log("‚úÖ Rulebook Rendered");

  // ---------- Helpers ----------

  function prettify(str) {
    return str
      .replace(/_/g, " ")
      .replace(/\b\w/g, l => l.toUpperCase());
  }

  function renderObject(obj) {
    let out = "";

    if (typeof obj === "string") {
      return `<p>${obj}</p>`;
    }

    if (Array.isArray(obj)) {
      out += `<ul>`;
      obj.forEach(item => {
        out += `<li>${renderObject(item)}</li>`;
      });
      out += `</ul>`;
      return out;
    }

    if (typeof obj === "object") {
      for (const k in obj) {
        const title = prettify(k);
        out += `
          <div class="ability-boxed-callout">
            <strong>${title}</strong>
            ${renderObject(obj[k])}
          </div>
        `;
      }
    }

    return out;
  }

})();
